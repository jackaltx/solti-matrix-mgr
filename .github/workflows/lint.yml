---
name: Lint and Syntax Check

on:
  push:
    branches: [main, test]
  pull_request:
    branches: [main, test]

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint (strict on main, warnings on test)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "Running strict yamllint for main branch"
            yamllint --strict .
          else
            echo "Running yamllint for test branch (warnings allowed)"
            yamllint . || echo "Warnings found but allowed on test branch"
          fi

  markdown-lint:
    name: Markdown Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint (strict on main, warnings on test)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "Running strict markdownlint for main branch"
            markdownlint "**/*.md" --ignore node_modules --config .markdownlintrc
          else
            echo "Running markdownlint for test branch (warnings allowed)"
            markdownlint "**/*.md" --ignore node_modules --config .markdownlintrc || echo "Warnings found but allowed on test branch"
          fi

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ansible-lint
        run: pip install ansible-lint ansible-core yamllint

      - name: Run ansible-lint (strict on main, warnings on test)
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "Running strict ansible-lint for main branch"
            ansible-lint --strict
          else
            echo "Running ansible-lint for test branch (warnings allowed)"
            ansible-lint || echo "Warnings found but allowed on test branch"
          fi

  syntax-check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible-core

      - name: Syntax check all playbooks
        run: |
          # Only check actual playbooks in playbooks/ directory
          # Exclude role files (defaults/, tasks/, handlers/, vars/, meta/)
          # Skip module test playbooks (require collection to be installed)
          if [ -d "playbooks" ]; then
            for playbook in playbooks/*.yml playbooks/*.yaml; do
              [ -f "$playbook" ] || continue

              # Skip module test playbooks (they require custom modules)
              if [[ "$playbook" == *"module-test"* ]]; then
                echo "Skipping $playbook (requires collection modules)"
                continue
              fi

              echo "Checking $playbook"
              ansible-playbook --syntax-check "$playbook" || exit 1
            done
          else
            echo "No playbooks directory found, skipping syntax check"
          fi
