---
# inventory/group_vars/all.yml
# Shared configuration for all Matrix servers
#
# Sensitive values should be in vault.yml (ansible-vault encrypted)

#=============================================================================
# HOMESERVER CONNECTION
#=============================================================================

matrix_domain: "example.com"
synapse_homeserver_url: "https://matrix.{{ matrix_domain }}"
# synapse_admin_token: "{{ vault_synapse_admin_token }}"  # From vault.yml

# SSL verification (disable for self-signed certs in test environments)
synapse_validate_certs: true

#=============================================================================
# SYNAPSE CONFIGURATION OVERLAYS
#=============================================================================

# These get written to /etc/synapse/conf.d/*.yaml and merged with homeserver.yaml
synapse_config_overlays:
  # Federation settings
  federation:
    allow_public_rooms_over_federation: false
    # Whitelist specific servers for federation
    # federation_domain_whitelist:
    #   - matrix.org
    #   - example.com
  
  # Rate limiting (relaxed for testing)
  rate_limiting:
    rc_message:
      per_second: 1
      burst_count: 20
    rc_registration:
      per_second: 0.1
      burst_count: 3
  
  # Registration (closed by default)
  registration:
    enable_registration: false
    enable_registration_without_verification: false
    # Use registration tokens for controlled signups
    registration_requires_token: true

#=============================================================================
# USERS
#=============================================================================

synapse_users:
  # Admin user
  - user_id: "@admin:{{ matrix_domain }}"
    displayname: "Server Admin"
    admin: true
    password: "{{ vault_admin_password }}"
    state: present
  
  # Hookshot bot (for webhooks)
  - user_id: "@hookshot:{{ matrix_domain }}"
    displayname: "Hookshot Bot"
    admin: false
    password: "{{ vault_hookshot_password }}"
    state: present
    ratelimit_disabled: true  # Bots need this
  
  # Maubot (for other bots)
  - user_id: "@maubot:{{ matrix_domain }}"
    displayname: "Maubot"
    admin: false
    password: "{{ vault_maubot_password }}"
    state: present
    ratelimit_disabled: true
  
  # Test users for reference implementation
  - user_id: "@alice:{{ matrix_domain }}"
    displayname: "Alice (Test User)"
    password: "{{ vault_test_password }}"
    state: present
  
  - user_id: "@bob:{{ matrix_domain }}"
    displayname: "Bob (Test User)"
    password: "{{ vault_test_password }}"
    state: present

#=============================================================================
# APPSERVICES
#=============================================================================

# Registration files for bridges/bots
synapse_appservices: []
# Example:
#   - name: hookshot
#     registration_file: "{{ playbook_dir }}/files/appservices/hookshot.yaml"
#   - name: maubot
#     registration_file: "{{ playbook_dir }}/files/appservices/maubot.yaml"

#=============================================================================
# HOOKSHOT WEBHOOKS
#=============================================================================

hookshot_webhook_url_prefix: "https://matrix.{{ matrix_domain }}/hookshot/webhook"

hookshot_webhooks:
  # CI/CD notifications
  - name: "ci-builds"
    room_id: "!TBD:{{ matrix_domain }}"  # Create room first, then update
    enabled: true
  
  # Alertmanager alerts
  - name: "alerts"
    room_id: "!TBD:{{ matrix_domain }}"
    enabled: true
    template: "alertmanager"
  
  # Generic notifications
  - name: "notifications"
    room_id: "!TBD:{{ matrix_domain }}"
    enabled: true

#=============================================================================
# PATHS (adjust for your install method)
#=============================================================================

# For Proxmox Helper-Script LXC install:
synapse_config_dir: "/etc/synapse"
synapse_service_name: "matrix-synapse"

# For spantaleev Docker playbook:
# synapse_config_dir: "/matrix/synapse/config"
# synapse_service_name: "matrix-synapse"  # Or use Docker

# Hookshot paths
hookshot_config_dir: "/matrix/hookshot"  # Docker
# hookshot_config_dir: "/etc/matrix-hookshot"  # Standalone
hookshot_is_containerized: true
hookshot_container_name: "matrix-hookshot"
